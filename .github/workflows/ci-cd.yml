name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, closed]

env:
  AWS_REGION: eu-west-1

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Python dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install ruff mypy pytest httpx==0.27.2

      - name: Backend lint
        run: cd backend && ruff check app/

      - name: Backend typecheck
        run: cd backend && mypy app/

      - name: Backend test
        run: cd backend && pytest tests/ -v

      - name: Install Node dependencies
        run: cd frontend && npm ci

      - name: Frontend lint
        run: cd frontend && npm run lint

      - name: Frontend typecheck
        run: cd frontend && npm run typecheck

  deploy:
    needs: check
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'pull_request' && github.event.action != 'closed')
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    environment:
      name: ${{ github.event_name == 'push' && 'production' || 'preview' }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActionsCinematchRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
        with:
          registries: ${{ secrets.AWS_ACCOUNT_ID }}

      - name: Determine workspace
        id: workspace
        run: |
          if [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "name=production" >> $GITHUB_OUTPUT
            echo "image_tag=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "domain=demo.cinematch.umans.ai" >> $GITHUB_OUTPUT
          else
            echo "name=pr-${{ github.event.number }}" >> $GITHUB_OUTPUT
            echo "image_tag=pr-${{ github.event.number }}" >> $GITHUB_OUTPUT
            echo "domain=demo-pr-${{ github.event.number }}.cinematch.umans.ai" >> $GITHUB_OUTPUT
          fi

      - name: Build and push backend
        run: |
          cd backend
          docker build \
            -t ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/cinematch-backend:${{ steps.workspace.outputs.image_tag }} \
            .
          docker push ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/cinematch-backend:${{ steps.workspace.outputs.image_tag }}

      - name: Build and push frontend
        run: |
          cd frontend
          docker build \
            -t ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/cinematch-frontend:${{ steps.workspace.outputs.image_tag }} \
            .
          docker push ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/cinematch-frontend:${{ steps.workspace.outputs.image_tag }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"

      - name: Deploy to environment
        id: deploy
        run: |
          cd operations/01-service
          terraform init

          # Select or create workspace
          terraform workspace select ${{ steps.workspace.outputs.name }} || terraform workspace new ${{ steps.workspace.outputs.name }}

          # Apply
          terraform apply -auto-approve -var="image_tag=${{ steps.workspace.outputs.image_tag }}"

          # Output URL
          echo "url=https://${{ steps.workspace.outputs.domain }}" >> $GITHUB_OUTPUT
          echo "Deployed to: https://${{ steps.workspace.outputs.domain }}"

      - name: Comment PR
        if: github.event_name == 'pull_request' && github.event.action != 'closed'
        uses: actions/github-script@v7
        with:
          script: |
            const workspace = 'pr-${{ github.event.number }}';
            const url = '${{ steps.deploy.outputs.url }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ Preview deployed: ${url}\n\nWorkspace: \`${workspace}\``
            });

  destroy-preview:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/GitHubActionsCinematchRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Destroy preview
        run: |
          cd operations/01-service
          terraform init

          WORKSPACE="pr-${{ github.event.number }}"

          # Check if workspace exists
          if terraform workspace list | grep -q "$WORKSPACE"; then
            terraform workspace select "$WORKSPACE"
            terraform destroy -auto-approve
            terraform workspace select production
            terraform workspace delete "$WORKSPACE"
            echo "Preview environment $WORKSPACE destroyed"
          else
            echo "Workspace $WORKSPACE does not exist, skipping"
          fi
